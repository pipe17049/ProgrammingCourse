#!/bin/bash

# Patrones de Lectura de Archivos y Directorios en Bash
# Descripcion: Ejemplos practicos para leer configuraciones de monitoreo web
# Uso: ./bash_reading_patterns.sh [ejemplo]

SCRIPT_NAME=$(basename "$0")

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Funcion de logging
log() {
    local level="$1"
    shift
    local message="$*"
    
    case "$level" in
        INFO) echo -e "${BLUE}[INFO]${NC} $message" ;;
        SUCCESS) echo -e "${GREEN}[SUCCESS]${NC} $message" ;;
        WARNING) echo -e "${YELLOW}[WARNING]${NC} $message" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} $message" ;;
        HEADER) echo -e "\n${CYAN}=== $message ===${NC}" ;;
    esac
}

# =============================================================================
# EJEMPLO 1: FOR con GLOB - Leer Directorios (BASICO)
# =============================================================================
ejemplo_for_directorios_basico() {
    log HEADER "Ejemplo 1: FOR con Directorios - B√°sico"
    
    # ‚úÖ CORRECTO - Expandir glob de directorios
    for site_dir in config/*/; do
        # Verificar si el directorio realmente existe
        if [ -d "$site_dir" ]; then
            echo "  üìÅ Directorio encontrado: $site_dir"
        else
            echo "  ‚ùå No hay directorios con patr√≥n config/*/"
            break
        fi
    done
}

# =============================================================================
# EJEMPLO 2: FOR con GLOB - Lectura Robusta
# =============================================================================
ejemplo_for_directorios_robusto() {
    log HEADER "Ejemplo 2: FOR con Directorios - Robusto"
    
    # ‚úÖ ROBUSTO - Con validaci√≥n y nombre limpio
    for site_dir in config/*/; do
        # Saltar si no hay coincidencias (glob no expandido)
        [ ! -d "$site_dir" ] && continue
        
        # Obtener nombre del sitio (quitar config/ y /)
        site_name=$(basename "$site_dir")
        
        echo "  üåê Sitio: $site_name"
        echo "     üìç Ruta: $site_dir"
    done
}

# =============================================================================
# EJEMPLO 3: Leer Contenido de Archivos
# =============================================================================
ejemplo_leer_archivos() {
    log HEADER "Ejemplo 3: Leer Contenido de Archivos"
    
    # ‚úÖ LEER archivo url.txt de cada sitio
    for site_dir in config/*/; do
        [ ! -d "$site_dir" ] && continue
        
        site_name=$(basename "$site_dir")
        url_file="$site_dir/url.txt"
        
        # Verificar que el archivo existe
        if [ -f "$url_file" ]; then
            # Leer URL del archivo y limpiar espacios/saltos de l√≠nea
            url=$(cat "$url_file" | tr -d '\r\n' | xargs)
            echo "  üåê $site_name ‚Üí üîó $url"
        else
            echo "  ‚ùå $site_name ‚Üí ERROR: $url_file no existe"
        fi
    done
}

# =============================================================================
# EJEMPLO 4: Validaci√≥n Completa
# =============================================================================
ejemplo_validacion_completa() {
    log HEADER "Ejemplo 4: Validaci√≥n Completa"
    
    # ‚úÖ VALIDACI√ìN COMPLETA - Producci√≥n ready
    for site_dir in config/*/; do
        # 1. Verificar directorio existe
        [ ! -d "$site_dir" ] && continue
        
        site_name=$(basename "$site_dir")
        url_file="$site_dir/url.txt"
        
        # 2. Verificar archivo existe
        if [ ! -f "$url_file" ]; then
            echo "  ‚ùå $site_name: sin archivo url.txt"
            continue
        fi
        
        # 3. Leer y validar URL no est√° vac√≠a
        url=$(cat "$url_file" | tr -d '\r\n' | xargs)
        
        if [ -z "$url" ]; then
            echo "  ‚ùå $site_name: URL vac√≠a"
            continue
        fi
        
        # 4. Validar formato b√°sico de URL
        if [[ ! "$url" =~ ^https?:// ]]; then
            echo "  ‚ö†Ô∏è  $site_name: URL sin protocolo ‚Üí $url"
        else
            echo "  ‚úÖ $site_name ‚Üí $url"
        fi
    done
}

# =============================================================================
# EJEMPLO 5: Contadores y Estad√≠sticas
# =============================================================================
ejemplo_contadores() {
    log HEADER "Ejemplo 5: Contadores y Estad√≠sticas"
    
    # ‚úÖ CONTADORES - Para reportes y logs
    local total_sites=0
    local valid_sites=0
    local invalid_sites=0
    
    for site_dir in config/*/; do
        [ ! -d "$site_dir" ] && continue
        
        total_sites=$((total_sites + 1))
        site_name=$(basename "$site_dir")
        url_file="$site_dir/url.txt"
        
        if [ -f "$url_file" ]; then
            url=$(cat "$url_file" | tr -d '\r\n' | xargs)
            if [ -n "$url" ]; then
                valid_sites=$((valid_sites + 1))
                echo "  ‚úÖ $site_name"
            else
                invalid_sites=$((invalid_sites + 1))
                echo "  ‚ùå $site_name (URL vac√≠a)"
            fi
        else
            invalid_sites=$((invalid_sites + 1))
            echo "  ‚ùå $site_name (sin url.txt)"
        fi
    done
    
    echo ""
    echo "  üìä Total: $total_sites | V√°lidos: $valid_sites | Inv√°lidos: $invalid_sites"
}

# =============================================================================
# EJEMPLO 6: Manejo de Espacios y Caracteres Especiales
# =============================================================================
ejemplo_caracteres_especiales() {
    log HEADER "Ejemplo 6: Manejo de Espacios y Caracteres Especiales"
    
    log INFO "Creando directorio temporal con espacios para demostrar..."
    
    # Crear un directorio temporal con espacios para demostrar
    mkdir -p "config/sitio con espacios" 2>/dev/null
    echo "https://example.com" > "config/sitio con espacios/url.txt" 2>/dev/null
    
    # ‚úÖ MANEJO SEGURO - Con comillas y validaci√≥n
    for site_dir in config/*/; do
        # SIEMPRE usar comillas dobles para variables
        [ ! -d "$site_dir" ] && continue
        
        site_name=$(basename "$site_dir")
        url_file="$site_dir/url.txt"
        
        # Usar comillas en todos los tests
        if [ -f "$url_file" ]; then
            # M√∫ltiples m√©todos de lectura segura
            url=$(head -1 "$url_file" | tr -d '\r\n' | xargs)
            
            # Validar que no est√© vac√≠o DESPU√âS de limpiar
            if [ -n "$url" ]; then
                echo "  üåê Sitio: '$site_name' ‚Üí URL: '$url'"
            fi
        fi
    done
    
    # Limpiar directorio temporal
    rm -rf "config/sitio con espacios" 2>/dev/null
    log INFO "Directorio temporal eliminado"
}

# =============================================================================
# EJEMPLO 7: CURL con Status Code y Timing
# =============================================================================
ejemplo_curl_monitoring() {
    log HEADER "Ejemplo 7: CURL para Web Monitoring"
    
    # ‚úÖ CURL COMPLETO - Con status, timing y manejo de errores
    for site_dir in config/*/; do
        [ ! -d "$site_dir" ] && continue
        
        site_name=$(basename "$site_dir")
        url_file="$site_dir/url.txt"
        
        # Verificar archivo y leer URL
        if [ ! -f "$url_file" ]; then
            echo "  ‚ùå $site_name: sin url.txt"
            continue
        fi
        
        url=$(cat "$url_file" | tr -d '\r\n' | xargs)
        [ -z "$url" ] && continue
        
        echo "  üåê Probando $site_name ($url)..."
        
        # CURL con informaci√≥n completa
        response=$(curl -s -w "STATUS:%{http_code}|TIME:%{time_total}s|SIZE:%{size_download}bytes" \
                       --max-time 10 \
                       --connect-timeout 5 \
                       "$url" 2>/dev/null)
        
        if [ $? -eq 0 ]; then
            # Extraer m√©tricas de la respuesta
            metrics=$(echo "$response" | tail -1)
            status_code=$(echo "$metrics" | cut -d'|' -f1 | cut -d':' -f2)
            time_total=$(echo "$metrics" | cut -d'|' -f2 | cut -d':' -f2)
            size_bytes=$(echo "$metrics" | cut -d'|' -f3 | cut -d':' -f2)
            
            # Determinar estado basado en c√≥digo HTTP
            if [ "$status_code" -ge 200 ] && [ "$status_code" -lt 300 ]; then
                echo "     ‚úÖ HTTP $status_code | ‚è±Ô∏è  $time_total | üì¶ $size_bytes"
            elif [ "$status_code" -ge 300 ] && [ "$status_code" -lt 400 ]; then
                echo "     üîÑ HTTP $status_code (Redirect) | ‚è±Ô∏è  $time_total"
            elif [ "$status_code" -ge 400 ] && [ "$status_code" -lt 500 ]; then
                echo "     ‚ö†Ô∏è  HTTP $status_code (Client Error) | ‚è±Ô∏è  $time_total"
            elif [ "$status_code" -ge 500 ]; then
                echo "     üí• HTTP $status_code (Server Error) | ‚è±Ô∏è  $time_total"
            else
                echo "     ‚ùì HTTP $status_code (Unknown) | ‚è±Ô∏è  $time_total"
            fi
        else
            echo "     üíÄ CURL FAILED - Timeout o conexi√≥n fallida"
        fi
        
        # Peque√±a pausa entre requests
        sleep 0.5
    done
}

# =============================================================================
# EJEMPLO 8: CURL Avanzado con Headers y Logs
# =============================================================================
ejemplo_curl_avanzado() {
    log HEADER "Ejemplo 8: CURL Avanzado - Headers y Logging"
    
    # Crear directorio temporal para logs
    mkdir -p "/tmp/curl_logs"
    timestamp=$(date '+%Y%m%d_%H%M%S')
    
    # ‚úÖ CURL PROFESIONAL - Con logs detallados
    for site_dir in config/*/; do
        [ ! -d "$site_dir" ] && continue
        
        site_name=$(basename "$site_dir")
        url_file="$site_dir/url.txt"
        
        [ ! -f "$url_file" ] && continue
        url=$(cat "$url_file" | tr -d '\r\n' | xargs)
        [ -z "$url" ] && continue
        
        echo "  üîç An√°lisis completo: $site_name"
        
        # Log file para este sitio
        log_file="/tmp/curl_logs/${site_name}_${timestamp}.log"
        
        # CURL con logging completo
        curl -s -I \
             -w "‚è±Ô∏è  Total: %{time_total}s | DNS: %{time_namelookup}s | Connect: %{time_connect}s | Transfer: %{time_starttransfer}s\nüìè Size: %{size_download} bytes | Speed: %{speed_download} bytes/s\nüîó Status: %{http_code} | Redirects: %{num_redirects}\n" \
             --max-time 10 \
             --user-agent "WebMonitor/1.0 (Learning Project)" \
             "$url" > "$log_file" 2>&1
        
        if [ $? -eq 0 ]; then
            # Mostrar solo m√©tricas clave
            tail -3 "$log_file" | while read line; do
                echo "     $line"
            done
        else
            echo "     üíÄ Request failed - Ver $log_file"
        fi
    done
    
    echo ""
    log INFO "Logs guardados en: /tmp/curl_logs/"
    ls -la /tmp/curl_logs/ 2>/dev/null | grep "_${timestamp}.log" | head -3
}

# =============================================================================
# ERRORES COMUNES
# =============================================================================
mostrar_errores_comunes() {
    log HEADER "‚ùå ERRORES COMUNES A EVITAR"
    
    echo ""
    log ERROR "1. FOR SIN VALIDACI√ìN:"
    echo "   for dir in config/*/; do"
    echo "       echo \$dir  # ‚Üê Puede imprimir 'config/*' si no hay directorios"
    echo "   done"
    echo ""
    
    log ERROR "2. VARIABLES SIN COMILLAS:"
    echo "   if [ -f \$url_file ]; then  # ‚Üê Falla si hay espacios"
    echo ""
    
    log ERROR "3. NO LIMPIAR ENTRADA:"
    echo "   url=\$(cat file.txt)  # ‚Üê Puede incluir \\r\\n"
    echo ""
    
    log ERROR "4. NO VALIDAR CONTENIDO:"
    echo "   cat \"\$file\" | some_command  # ‚Üê Falla si file est√° vac√≠o"
    echo ""
    
    log SUCCESS "‚úÖ PATRONES CORRECTOS:"
    echo ""
    echo "1. ‚úÖ FOR CON VALIDACI√ìN:"
    echo "   for dir in config/*/; do"
    echo "       [ ! -d \"\$dir\" ] && continue"
    echo "       echo \"\$dir\""
    echo "   done"
    echo ""
    
    echo "2. ‚úÖ VARIABLES CON COMILLAS:"
    echo "   if [ -f \"\$url_file\" ]; then"
    echo ""
    
    echo "3. ‚úÖ LIMPIAR ENTRADA:"
    echo "   url=\$(cat \"\$file\" | tr -d '\\r\\n' | xargs)"
    echo ""
    
    echo "4. ‚úÖ VALIDAR ANTES DE USAR:"
    echo "   [ -n \"\$url\" ] && process_url \"\$url\""
    echo ""
}

# =============================================================================
# FUNCI√ìN PRINCIPAL
# =============================================================================
main() {
    local ejemplo="${1:-all}"
    
    case "$ejemplo" in
        1|basico)
            ejemplo_for_directorios_basico
            ;;
        2|robusto)
            ejemplo_for_directorios_robusto
            ;;
        3|archivos)
            ejemplo_leer_archivos
            ;;
        4|validacion)
            ejemplo_validacion_completa
            ;;
        5|contadores)
            ejemplo_contadores
            ;;
        6|espacios)
            ejemplo_caracteres_especiales
            ;;
        7|curl)
            ejemplo_curl_monitoring
            ;;
        8|curl-avanzado)
            ejemplo_curl_avanzado
            ;;
        errores)
            mostrar_errores_comunes
            ;;
        all)
            ejemplo_for_directorios_basico
            ejemplo_for_directorios_robusto
            ejemplo_leer_archivos
            ejemplo_validacion_completa
            ejemplo_contadores
            ejemplo_caracteres_especiales
            ejemplo_curl_monitoring
            ejemplo_curl_avanzado
            ejemplo_redireccion
            mostrar_errores_comunes
            ;;
        9|redireccion)
            ejemplo_redireccion
            ;;
        help|-h|--help)
            echo "Uso: $SCRIPT_NAME [ejemplo]"
            echo ""
            echo "Ejemplos disponibles:"
            echo "  1, basico       - FOR b√°sico con directorios"
            echo "  2, robusto      - FOR robusto con validaci√≥n"
            echo "  3, archivos     - Leer contenido de archivos"
            echo "  4, validacion   - Validaci√≥n completa"
            echo "  5, contadores   - Contadores y estad√≠sticas"
            echo "  6, espacios     - Manejo de caracteres especiales"
            echo "  7, curl         - CURL con status y timing"
            echo "  8, curl-avanzado - CURL con headers y logs"
            echo "  9, redireccion  - Redirecci√≥n > >> < | &"
            echo "  errores         - Errores comunes"
            echo "  all             - Todos los ejemplos"
            ;;
        *)
            log ERROR "Ejemplo no reconocido: $ejemplo"
            echo "Usa '$SCRIPT_NAME help' para ver opciones disponibles"
            exit 1
            ;;
    esac
}

# Ejecutar funci√≥n principal
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
